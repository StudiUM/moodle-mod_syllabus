define(["jquery","core/str","core/notification","mod_syllabus/requiredfields_popup"],function(a,b,c,d){var e=function(a,b,c){this.configdatepicker=a,this.configmanageline=b,this.fieldfortypeofsubmit=c,this.tabsinit(),this.managelines(),this.onclickbuttons()};return e.prototype.nbrepeat=[],e.prototype.configdatepicker=[],e.prototype.configmanageline=[],e.prototype.requiredfieldspopup=null,e.prototype.fieldfortypeofsubmit="",e.prototype.managelines=function(){var d=this;a.each(this.configmanageline,function(b,c){d.nbrepeat[c.identifier]=parseInt(a('input[name="'+c.name+'"]').val()),d.reorderlines(c.identifier,c.name)}),a("#page-mod-syllabus-edit").on("click","a.deleteline",function(e){e.preventDefault();var f=a(this).data("id"),g=a(this).data("repeat"),h=a(this);b.get_strings([{key:"confirm",component:"moodle"},{key:"confirmdeleteline",component:"mod_syllabus"},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(b){c.confirm(b[0],b[1],b[2],b[3],function(){var b=h.closest(".syllabus_repeated_item");b.remove(),d.nbrepeat[f]--,d.nbrepeat[f]||a("#"+f+".syllabus_repeated_items_block").removeClass("greyborder"),d.reorderlines(f,g)})}).fail(c.exception)}),a("#page-mod-syllabus-edit").on("click",".addline",function(b){b.preventDefault();var c=a(this).data("id"),e=a(this).data("repeat"),f=a("#"+c+" .hidden");f.clone().addClass("newline").insertBefore("#"+c+" .hidden"),a("#"+c+" .newline [name^='"+c+"_']").each(function(){var b=a(this).attr("name"),e=/newindex/g,f=d.nbrepeat[c]+1,g=b.replace(e,f.toString());a(this).attr("name",g)}),a(".newline").removeClass("newline hidden"),d.nbrepeat[c]||a("#"+c+".syllabus_repeated_items_block").addClass("greyborder"),d.nbrepeat[c]++,d.reorderlines(c,e),Y.use("moodle-form-dateselector",function(){M.form.dateselector.init_date_selectors(d.configdatepicker)})})},e.prototype.reorderlines=function(b,c){var d=this;a("#"+b+" .syllabus_repeated_item:not(.hidden)").each(function(c){a(this).find("[name^='"+b+"_']").each(function(){var b=a(this).attr("name"),d=/\[[0-9]+\]/g,e=b.replace(d,"["+c.toString()+"]");a(this).attr("name",e)})}),a('input[name="'+c+'"]').val(d.nbrepeat[b])},e.prototype.tabsinit=function(){b.get_strings([{key:"collapseall"},{key:"expandall"}]).done(function(b){var c=b[0],d=b[1];a(".syllabus").on("click",".collapsible-actions a",function(b){b.preventDefault();var e=a(this).closest("div.tab-pane").attr("id");a(this).hasClass("collapse-all")?(a(this).text(d),a(this).toggleClass("collapse-all expand-all"),a(".syllabus #"+e+" fieldset.collapsible:not(.collapsed) a.fheader").trigger("click")):(a(this).text(c),a(this).toggleClass("collapse-all expand-all"),a(".syllabus #"+e+" fieldset.collapsible.collapsed a.fheader").trigger("click"))}),a(".syllabus").on("click","ul.nav-tabs li.nav-item a",function(b){b.preventDefault();var c=a(this).data("tab");a('input[name="rubric"]').val(c)}),a(".syllabus legend a.fheader").on("click",function(b){b.preventDefault();var e=a(this).attr("aria-controls"),f=a(this).closest("div.tab-pane").attr("id");a("#"+e).toggleClass("collapsed"),a("#"+e).hasClass("collapsed")?a(this).attr("aria-expanded",!1):a(this).attr("aria-expanded",!0);var g=!0,h=!0;a(".syllabus #"+f+" fieldset.collapsible").each(function(){g=a(this).hasClass("collapsed")&&g,h=!a(this).hasClass("collapsed")&&h});var i=a(".syllabus #"+f+" .collapsible-actions a");i.hasClass("collapse-all")&&g?(i.text(d),i.toggleClass("collapse-all expand-all")):i.hasClass("expand-all")&&h&&(i.text(c),i.toggleClass("collapse-all expand-all"))})}).fail(c.exception)},e.prototype.onclickbuttons=function(){var b=this;a('#page-mod-syllabus-edit [data-submitbtn="true"]').each(function(c,e){a(e).on("click",function(c){c.preventDefault();var e=[];if(a('[data-required="true"]').each(function(b,c){if(!a(this).closest(".syllabus_repeated_item").hasClass("hidden")){var d=c,f=a(c).val();if(a(d).data("editorfield")){var g="#id_"+a(d).data("editorfield");a(g+"editable").length?(d=g+"editable",f=a(g+"editable").text()):a(g+"_parent").length?(d=g+"_parent .mceIframeContainer",f=a(g+"_ifr").contents().find("body").text()):(d=g,f=a(d).val())}if(""==f.trim()){a(d).addClass("is-invalid");var h=a(c).parents('[role="tabpanel"]').data("tabname");a.inArray(h,e)==-1&&e.push(h)}else a(d).removeClass("is-invalid")}}),a('[data-morethanone="true"]').each(function(b,c){if(a(c).val()<1){a('[data-repeat="'+a(c).attr("name")+'"]').addClass("is-invalid");var d=a(c).data("tabname");a.inArray(d,e)==-1&&e.push(d)}else a('[data-repeat="'+a(c).attr("name")+'"]').removeClass("is-invalid")}),a("#page-mod-syllabus-edit [name="+b.fieldfortypeofsubmit+"]").val(c.target.name),e.length>0)d.init(e,a(this).parents("form"));else{var f=window.onbeforeunload;window.onbeforeunload=null,f(),a(this).parents("form").submit(),window.onbeforeunload=f}})})},{init:function(a,b,c){new e(a,b,c)}}});